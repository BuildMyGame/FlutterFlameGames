// [{"x":2,"y":2,"M":93.6,"U":88.4},{"x":2,"y":93,"M":30.8,"U":30.4},{"x":2,"y":126,"M":28,"U":30.4},{"x":2,"y":159,"M":25.6,"U":30.4},{"x":2,"y":192,"M":23.2,"U":30.4},{"x":2,"y":225,"M":20.4,"U":30.4},{"x":2,"y":258,"M":18.4,"U":30.4},{"x":2,"y":291,"M":16,"U":30.8},{"x":98,"y":2,"M":13.6,"U":30.8},{"x":98,"y":35,"M":11.2,"U":31.2},{"x":98,"y":69,"M":11.2,"U":31.2},{"x":98,"y":103,"M":14,"U":30.8},{"x":98,"y":136,"M":16.8,"U":30.8},{"x":98,"y":169,"M":19.2,"U":30.8},{"x":98,"y":202,"M":22.4,"U":30.8},{"x":98,"y":235,"M":25.2,"U":30.8},{"x":126,"y":2,"M":27.6,"U":30.8},{"x":126,"y":35,"M":30.4,"U":30.8},{"x":126,"y":68,"M":33.2,"U":31.2},{"x":126,"y":102,"M":70,"U":70},{"x":126,"y":174,"M":70,"U":70},{"x":126,"y":246,"M":70,"U":70},{"x":126,"y":318,"M":70,"U":70},{"x":126,"y":390,"M":70,"U":70},{"x":198,"y":2,"M":70,"U":70},{"x":198,"y":74,"M":70,"U":70},{"x":198,"y":146,"M":70,"U":70},{"x":198,"y":218,"M":70,"U":70},{"x":198,"y":290,"M":70,"U":70},{"x":198,"y":362,"M":70,"U":70},{"x":198,"y":434,"M":70,"U":70},{"x":198,"y":506,"M":70,"U":70},{"x":270,"y":2,"M":70,"U":70},{"x":270,"y":74,"M":70,"U":70},{"x":270,"y":146,"M":70,"U":70},{"x":270,"y":218,"M":70,"U":70},{"x":270,"y":290,"M":70,"U":70},{"x":270,"y":362,"M":70,"U":70},{"x":270,"y":434,"M":70,"U":70},{"x":270,"y":506,"M":70,"U":70},{"x":342,"y":2,"M":70,"U":70},{"x":342,"y":74,"M":70,"U":70},{"x":342,"y":146,"M":70,"U":70},{"x":342,"y":218,"M":70,"U":70},{"x":342,"y":290,"M":70,"U":70},{"x":342,"y":362,"M":70,"U":70},{"x":342,"y":434,"M":70,"U":70},{"x":342,"y":506,"M":70,"U":70},{"x":414,"y":2,"M":70,"U":70},{"x":414,"y":74,"M":70,"U":70},{"x":414,"y":146,"M":70,"U":70},{"x":414,"y":218,"M":70,"U":70},{"x":414,"y":290,"M":70,"U":70},{"x":414,"y":362,"M":70,"U":70},{"x":414,"y":434,"M":70,"U":70},{"x":414,"y":506,"M":70,"U":70},{"x":486,"y":2,"M":91.6,"U":92.4},{"x":486,"y":97,"M":91.6,"U":92.4},{"x":486,"y":192,"M":196,"U":196.8}]
// [{"x":62.4,"y":62.4},{"x":93.2,"y":92.4},{"x":94.4,"y":92.4},{"x":95.6,"y":92.4},{"x":96.8,"y":92.4},{"x":98.4,"y":92.4},{"x":99.2,"y":92.4},{"x":100.4,"y":92.4},{"x":101.6,"y":92.4},{"x":102.8,"y":92.4},{"x":102.8,"y":92.4},{"x":101.2,"y":92.4},{"x":100,"y":92.4},{"x":98.8,"y":92.4},{"x":97.2,"y":92.4},{"x":96,"y":92.4},{"x":94.8,"y":92.4},{"x":93.6,"y":92.4},{"x":92,"y":92},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":73.6,"y":73.6},{"x":62,"y":63.6},{"x":62,"y":63.6},{"x":10.8,"y":8.4}]
// 221, 221
// obj_star_idle
// [{"x":2,"y":2,"M":98.4,"U":107.2},{"x":2,"y":112,"M":133.6,"U":148},{"x":2,"y":262,"M":82,"U":92.4},{"x":2,"y":357,"M":123.2,"U":141.2},{"x":138,"y":2,"M":154.8,"U":184.4},{"x":138,"y":189,"M":129.6,"U":159.6},{"x":138,"y":351,"M":134,"U":131.2},{"x":138,"y":485,"M":118.4,"U":106.4},{"x":295,"y":2,"M":96,"U":92},{"x":295,"y":96,"M":82.8,"U":86.8},{"x":295,"y":185,"M":81.6,"U":82},{"x":295,"y":269,"M":80,"U":77.6},{"x":393,"y":2,"M":78,"U":53.2}]
// [{"x":58,"y":46.4},{"x":30.4,"y":15.2},{"x":66.4,"y":52.8},{"x":45.2,"y":22.4},{"x":30,"y":-0.8},{"x":45.2,"y":13.6},{"x":34.8,"y":32.8},{"x":40.8,"y":45.6},{"x":51.2,"y":49.6},{"x":59.2,"y":52},{"x":59.6,"y":53.6},{"x":60.4,"y":55.2},{"x":61.2,"y":56.4}]
// 221, 221
// obj_star_disappear

import 'dart:async';

import 'package:flame/cache.dart';
import 'package:flame/collisions.dart';
import 'package:flame/components.dart';
import 'package:flame/events.dart';
import 'package:flame/image_composition.dart';
import 'package:flame/sprite.dart';
import 'package:flame_forge2d/flame_forge2d.dart';
import 'package:flutter/material.dart';

enum CTRStarState { idle, disappear }

class CTRStar extends PositionComponent {
  final Images? images;
  late SpriteAnimationGroupComponent _animationComponent;
  CTRStar({this.images});

  @override
  FutureOr<void> onLoad() async {
    size = Vector2(221, 221);

    add(CircleHitbox(radius: 10)
      ..anchor = Anchor.center
      ..position = size * 0.5);

    final idleSprites = await _idleSprites();
    final disappearSprites = await _disappearSprites();

    final animMap = {
      CTRStarState.idle: SpriteAnimation.spriteList(idleSprites.sublist(1, 18),
          stepTime: 0.05, loop: true),
      CTRStarState.disappear: SpriteAnimation.spriteList(
          disappearSprites.sublist(0, 12),
          stepTime: 0.05,
          loop: false),
    };
    _animationComponent = SpriteAnimationGroupComponent(
        animations: animMap, current: CTRStarState.idle);
    _animationComponent.position = Vector2(0, 0);
    _animationComponent.anchor = Anchor.topLeft;
    add(_animationComponent);

    return super.onLoad();
  }

  disappear() {
    _animationComponent.current = CTRStarState.disappear;
    _animationComponent.animationTickers?[CTRStarState.disappear]?.onComplete =
        () {
      removeFromParent();
    };
  }

  Future<List<Sprite>> _idleSprites() async {
    List<Sprite> sprites = [];
    final List<Map<String, double>> rects = [
      {"x": 2, "y": 2, "M": 93.6, "U": 88.4},
      {"x": 2, "y": 93, "M": 30.8, "U": 30.4},
      {"x": 2, "y": 126, "M": 28, "U": 30.4},
      {"x": 2, "y": 159, "M": 25.6, "U": 30.4},
      {"x": 2, "y": 192, "M": 23.2, "U": 30.4},
      {"x": 2, "y": 225, "M": 20.4, "U": 30.4},
      {"x": 2, "y": 258, "M": 18.4, "U": 30.4},
      {"x": 2, "y": 291, "M": 16, "U": 30.8},
      {"x": 98, "y": 2, "M": 13.6, "U": 30.8},
      {"x": 98, "y": 35, "M": 11.2, "U": 31.2},
      {"x": 98, "y": 69, "M": 11.2, "U": 31.2},
      {"x": 98, "y": 103, "M": 14, "U": 30.8},
      {"x": 98, "y": 136, "M": 16.8, "U": 30.8},
      {"x": 98, "y": 169, "M": 19.2, "U": 30.8},
      {"x": 98, "y": 202, "M": 22.4, "U": 30.8},
      {"x": 98, "y": 235, "M": 25.2, "U": 30.8},
      {"x": 126, "y": 2, "M": 27.6, "U": 30.8},
      {"x": 126, "y": 35, "M": 30.4, "U": 30.8},
      {"x": 126, "y": 68, "M": 33.2, "U": 31.2},
      {"x": 126, "y": 102, "M": 70, "U": 70},
      {"x": 126, "y": 174, "M": 70, "U": 70},
      {"x": 126, "y": 246, "M": 70, "U": 70},
      {"x": 126, "y": 318, "M": 70, "U": 70},
      {"x": 126, "y": 390, "M": 70, "U": 70},
      {"x": 198, "y": 2, "M": 70, "U": 70},
      {"x": 198, "y": 74, "M": 70, "U": 70},
      {"x": 198, "y": 146, "M": 70, "U": 70},
      {"x": 198, "y": 218, "M": 70, "U": 70},
      {"x": 198, "y": 290, "M": 70, "U": 70},
      {"x": 198, "y": 362, "M": 70, "U": 70},
      {"x": 198, "y": 434, "M": 70, "U": 70},
      {"x": 198, "y": 506, "M": 70, "U": 70},
      {"x": 270, "y": 2, "M": 70, "U": 70},
      {"x": 270, "y": 74, "M": 70, "U": 70},
      {"x": 270, "y": 146, "M": 70, "U": 70},
      {"x": 270, "y": 218, "M": 70, "U": 70},
      {"x": 270, "y": 290, "M": 70, "U": 70},
      {"x": 270, "y": 362, "M": 70, "U": 70},
      {"x": 270, "y": 434, "M": 70, "U": 70},
      {"x": 270, "y": 506, "M": 70, "U": 70},
      {"x": 342, "y": 2, "M": 70, "U": 70},
      {"x": 342, "y": 74, "M": 70, "U": 70},
      {"x": 342, "y": 146, "M": 70, "U": 70},
      {"x": 342, "y": 218, "M": 70, "U": 70},
      {"x": 342, "y": 290, "M": 70, "U": 70},
      {"x": 342, "y": 362, "M": 70, "U": 70},
      {"x": 342, "y": 434, "M": 70, "U": 70},
      {"x": 342, "y": 506, "M": 70, "U": 70},
      {"x": 414, "y": 2, "M": 70, "U": 70},
      {"x": 414, "y": 74, "M": 70, "U": 70},
      {"x": 414, "y": 146, "M": 70, "U": 70},
      {"x": 414, "y": 218, "M": 70, "U": 70},
      {"x": 414, "y": 290, "M": 70, "U": 70},
      {"x": 414, "y": 362, "M": 70, "U": 70},
      {"x": 414, "y": 434, "M": 70, "U": 70},
      {"x": 414, "y": 506, "M": 70, "U": 70},
      {"x": 486, "y": 2, "M": 91.6, "U": 92.4},
      {"x": 486, "y": 97, "M": 91.6, "U": 92.4},
      {"x": 486, "y": 192, "M": 196, "U": 196.8}
    ];
    final List<Offset> offsets = _idleOffsets();
    for (int i = 0; i < rects.length; ++i) {
      final rect = rects[i];
      final pos = Vector2(rect["x"]!, rect["y"]!);
      final size = Vector2(rect["M"]!, rect["U"]!);
      final sprite = await Sprite.load("obj_star_idle.png",
          srcPosition: pos, srcSize: size, images: images);
      final offset = offsets[i];
      final composition = ImageComposition()
        ..add(await sprite.toImage(), Vector2(offset.dx, offset.dy));
      final composeImage = await composition.compose();
      sprites.add(Sprite(composeImage));
    }
    return sprites;
  }

  List<Offset> _idleOffsets() {
    final List<Map<String, double>> raw = [
      {"x": 62.4, "y": 62.4},
      {"x": 93.2, "y": 92.4},
      {"x": 94.4, "y": 92.4},
      {"x": 95.6, "y": 92.4},
      {"x": 96.8, "y": 92.4},
      {"x": 98.4, "y": 92.4},
      {"x": 99.2, "y": 92.4},
      {"x": 100.4, "y": 92.4},
      {"x": 101.6, "y": 92.4},
      {"x": 102.8, "y": 92.4},
      {"x": 102.8, "y": 92.4},
      {"x": 101.2, "y": 92.4},
      {"x": 100, "y": 92.4},
      {"x": 98.8, "y": 92.4},
      {"x": 97.2, "y": 92.4},
      {"x": 96, "y": 92.4},
      {"x": 94.8, "y": 92.4},
      {"x": 93.6, "y": 92.4},
      {"x": 92, "y": 92},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 73.6, "y": 73.6},
      {"x": 62, "y": 63.6},
      {"x": 62, "y": 63.6},
      {"x": 10.8, "y": 8.4}
    ];
    List<Offset> offsets = [];
    for (final pos in raw) {
      offsets.add(Offset(pos["x"]!, pos["y"]!));
    }
    return offsets;
  }

  Future<List<Sprite>> _disappearSprites() async {
    List<Sprite> sprites = [];
    final List<Map<String, double>> rects = [
      {"x": 2, "y": 2, "M": 98.4, "U": 107.2},
      {"x": 2, "y": 112, "M": 133.6, "U": 148},
      {"x": 2, "y": 262, "M": 82, "U": 92.4},
      {"x": 2, "y": 357, "M": 123.2, "U": 141.2},
      {"x": 138, "y": 2, "M": 154.8, "U": 184.4},
      {"x": 138, "y": 189, "M": 129.6, "U": 159.6},
      {"x": 138, "y": 351, "M": 134, "U": 131.2},
      {"x": 138, "y": 485, "M": 118.4, "U": 106.4},
      {"x": 295, "y": 2, "M": 96, "U": 92},
      {"x": 295, "y": 96, "M": 82.8, "U": 86.8},
      {"x": 295, "y": 185, "M": 81.6, "U": 82},
      {"x": 295, "y": 269, "M": 80, "U": 77.6},
      {"x": 393, "y": 2, "M": 78, "U": 53.2}
    ];
    final List<Offset> offsets = _disappearOffsets();
    for (int i = 0; i < rects.length; ++i) {
      final rect = rects[i];
      final pos = Vector2(rect["x"]!, rect["y"]!);
      final size = Vector2(rect["M"]!, rect["U"]!);
      final sprite = await Sprite.load("obj_star_disappear.png",
          srcPosition: pos, srcSize: size, images: images);
      final offset = offsets[i];
      final composition = ImageComposition()
        ..add(await sprite.toImage(), Vector2(offset.dx, offset.dy));
      final composeImage = await composition.compose();
      sprites.add(Sprite(composeImage));
    }
    return sprites;
  }

  List<Offset> _disappearOffsets() {
    final List<Map<String, double>> raw = [
      {"x": 58, "y": 46.4},
      {"x": 30.4, "y": 15.2},
      {"x": 66.4, "y": 52.8},
      {"x": 45.2, "y": 22.4},
      {"x": 30, "y": -0.8},
      {"x": 45.2, "y": 13.6},
      {"x": 34.8, "y": 32.8},
      {"x": 40.8, "y": 45.6},
      {"x": 51.2, "y": 49.6},
      {"x": 59.2, "y": 52},
      {"x": 59.6, "y": 53.6},
      {"x": 60.4, "y": 55.2},
      {"x": 61.2, "y": 56.4}
    ];
    List<Offset> offsets = [];
    for (final pos in raw) {
      offsets.add(Offset(pos["x"]!, pos["y"]!));
    }
    return offsets;
  }
}
